# 项目系统性优化计划

## 一、优化建议梳理与分类

### 1. 性能优化（高优先级）
| 建议来源 | 优化点 | 优先级 |
|---------|--------|--------|
| Gemini | 截图/预览性能优化：替换pyscreenshot为mss | 高 |
| Gemini | 图像处理优化：替换PIL为OpenCV | 高 |
| Gemini | GUI框架升级：从tkinter迁移到PyQt5/PySide6 | 高 |
| doubao | 资源占用优化：降低系统资源消耗 | 中 |

### 2. 核心功能优化（高优先级）
| 建议来源 | 优化点 | 优先级 |
|---------|--------|--------|
| Gemini | 解决"鼠标打架"问题：改用PostMessage替代SendInput | 高 |
| Gemini | 窗口嵌入优化：使用DWM Thumbnail替代SetParent | 高 |
| Gemini | 完善三种模式切换逻辑 | 中 |

### 3. 架构与技术选型（中优先级）
| 建议来源 | 优化点 | 优先级 |
|---------|--------|--------|
| doubao | 评估Parsec VDD与其他方案适用性 | 中 |
| doubao | 优化切换体验：降低模式切换延迟 | 中 |
| Gemini | 完善坐标映射机制 | 中 |

### 4. 部署与稳定性（中优先级）
| 建议来源 | 优化点 | 优先级 |
|---------|--------|--------|
| doubao | 降低部署复杂度：简化驱动安装流程 | 中 |
| doubao | 提高系统稳定性：避免驱动失效问题 | 中 |

## 二、具体优化方案

### 1. 截图/预览性能优化
**目标**：将截图刷新率提升至20fps以上，降低CPU占用
**实施步骤**：
- 安装mss库替换pyscreenshot
- 修改control_panel.py中的refresh_virtual_preview方法
- 优化图像捕获与处理流程
**责任人**：开发者
**完成时间**：1天

### 2. 鼠标输入优化
**目标**：实现真正的后台鼠标控制，避免"鼠标打架"
**实施步骤**：
- 在independent_mouse.py中添加PostMessage/SendMessage支持
- 实现输入模式切换（PostMessage/SendInput）
- 优化坐标映射逻辑
**责任人**：开发者
**完成时间**：1天

### 3. 窗口嵌入优化
**目标**：解决SetParent导致的渲染问题，实现流畅预览
**实施步骤**：
- 研究DWM Thumbnail API
- 实现DWM缩略图预览功能
- 替换script_manager.py中的窗口嵌入逻辑
**责任人**：开发者
**完成时间**：2天

### 4. 图像处理优化
**目标**：提升图像识别与处理速度
**实施步骤**：
- 集成OpenCV库
- 优化图像缩放与显示逻辑
- 修改control_panel.py中的图像处理代码
**责任人**：开发者
**完成时间**：1天

### 5. GUI框架评估与升级
**目标**：评估tkinter与PyQt5/PySide6的适用性，决定是否升级
**实施步骤**：
- 测试tkinter在高帧率下的性能表现
- 研究PyQt5/PySide6的多线程渲染能力
- 制定框架迁移计划（如需要）
**责任人**：开发者
**完成时间**：2天

### 6. 三种模式切换逻辑优化
**目标**：实现流畅的模式切换体验
**实施步骤**：
- 优化主屏幕模式、小窗口监控模式、纯后台自动化模式的切换逻辑
- 实现模式切换时的资源智能分配
- 完善状态管理机制
**责任人**：开发者
**完成时间**：1天

## 三、实施与测试计划

### 1. 实施原则
- 保持与现有项目架构和功能兼容
- 采用渐进式优化，避免大规模重构
- 确保每步优化都有明确的测试验证

### 2. 测试计划
| 测试类型 | 测试内容 | 测试方法 |
|---------|----------|----------|
| 功能测试 | 截图预览功能 | 手动测试刷新率与清晰度 |
| 功能测试 | 鼠标输入功能 | 测试脚本运行时主屏幕鼠标是否正常 |
| 功能测试 | 窗口嵌入功能 | 测试各种游戏窗口的预览效果 |
| 性能测试 | CPU占用率 | 使用任务管理器监控 |
| 性能测试 | 内存占用率 | 使用任务管理器监控 |
| 性能测试 | 截图延迟 | 手动测试从操作到显示的延迟 |
| 兼容性测试 | 不同游戏兼容性 | 测试主流游戏的运行情况 |
| 兼容性测试 | 不同Windows版本 | 测试Win10/11系统 |

### 3. 优化报告整理
- 记录实施的优化点
- 记录解决的问题
- 记录带来的改进
- 为后续维护提供参考依据

## 四、预期成果

1. 截图刷新率提升至20fps以上，CPU占用降低50%
2. 实现真正的后台鼠标控制，避免"鼠标打架"
3. 解决窗口嵌入导致的渲染问题
4. 优化三种模式切换逻辑，实现流畅切换
5. 提高系统稳定性，降低资源占用
6. 提供详细的优化报告，为后续维护提供参考

## 五、风险评估

1. **技术风险**：DWM Thumbnail API可能在某些系统上不兼容
   - 缓解措施：保留SetParent作为备选方案

2. **性能风险**：GUI框架升级可能带来新的性能问题
   - 缓解措施：进行充分的性能测试，逐步迁移

3. **兼容性风险**：PostMessage/PostMessage可能在某些游戏上无效
   - 缓解措施：保留SendInput作为备选方案，实现自动降级机制

4. **时间风险**：部分优化点可能需要比预期更长的时间
   - 缓解措施：优先实施高优先级优化点，确保核心功能得到改善

本计划将确保项目在现有架构基础上进行系统性优化，提升性能和用户体验，同时保持稳定性和兼容性。