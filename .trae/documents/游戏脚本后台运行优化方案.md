# 游戏脚本后台运行优化方案

## 优化目标
根据 Gemini_advice.txt 的专业建议，解决后台运行脚本的技术难题，提升脚本执行效率、资源占用优化、错误处理机制完善和稳定性增强。

## 核心问题分析

### 问题 1：游戏窗口"透明化"导致无法截图/识别
- **现状**：script_manager.py 中使用 `SetLayeredWindowAttributes(hwnd, 0, 0, win32con.LWA_ALPHA)` 设置窗口透明度为 0
- **影响**：游戏引擎检测到透明度为 0 时停止渲染，导致截图全黑，Airtest 无法识别图片
- **解决方案**：移除所有透明度设置代码，利用虚拟屏幕，保持窗口不透明

### 问题 2：游戏不支持 PostMessage
- **现状**：现代游戏使用 DirectInput/RawInput 读取鼠标硬件数据，忽略 Windows 消息队列
- **影响**：虽然成功发送消息，但游戏引擎直接忽略，导致点击无效
- **解决方案**：实现"鼠标瞬移方案"作为备选方案

### 问题 3：坐标转换偏差
- **现状**：使用简单的减法计算 `client_x = screen_x - window_left`
- **影响**：未考虑窗口边框和标题栏，导致点击位置偏移
- **解决方案**：使用 `win32gui.ScreenToClient` API 进行精确转换

## 优化步骤

### 步骤 1：移除窗口透明度设置（script_manager.py）
- 删除 `manage_game_process` 方法中的透明度设置代码（L1274-L1290）
- 删除 `run_script` 方法中的透明度设置代码（L1181-1195）
- 修改窗口移动逻辑，将游戏窗口移动到虚拟屏幕而非屏幕外

### 步骤 2：优化坐标转换逻辑（background_windows.py）
- 在 `touch` 方法中使用 `win32gui.ScreenToClient` 替代手动减法计算
- 确保坐标转换精确，消除标题栏和边框带来的误差

### 步骤 3：实现鼠标瞬移备选方案（independent_mouse.py）
- 添加 `click_background_fallback` 方法
- 实现瞬移点击逻辑：保存位置 -> 移动到目标 -> 点击 -> 恢复位置
- 在 background_windows.py 中集成此备选方案

### 步骤 4：添加游戏兼容性测试
- 创建测试脚本验证 PostMessage 是否有效
- 根据测试结果自动选择点击方式

### 步骤 5：性能监控和日志优化
- 确保性能监控模块正常工作
- 优化日志输出，便于调试

## 预期效果
- ✅ 游戏窗口正常渲染，截图不再全黑
- ✅ 坐标转换精确，点击位置准确
- ✅ 支持 PostMessage 和鼠标瞬移两种方式
- ✅ 提升脚本稳定性和执行效率
- ✅ 完善的错误处理机制